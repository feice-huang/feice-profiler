<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feice Profiler</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --fc-today-bg-color: rgba(255, 252, 232, 0.5);
            --fc-now-indicator-color: #ea4335;
            --slot-height: 30px;
            --header-height: 44px;
        }
        body { 
            padding: 10px; 
            background-color: #f4f6f8; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-family: "HarmonyOS Sans SC", "Inter", system-ui, -apple-system, sans-serif;
            color: #1a1a1a;
            overflow: hidden; 
        }
        
        #app-container { 
            flex: 1; 
            background: #ffffff; 
            border-radius: 8px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.04); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Header --- */
        #header-bar {
            height: var(--header-height);
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
            flex-shrink: 0;
            font-size: 0.85rem;
        }

        .view-tabs .btn {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 2px 8px;
            color: #5f6368;
            border: none;
            border-radius: 4px;
        }
        .view-tabs .btn.active { color: #1967d2; background: #e8f0fe; }

        .sep { width: 1px; height: 16px; background: #e0e0e0; margin: 0 2px; }

        .nav-group .btn { 
            padding: 0 8px; 
            color: #444; 
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .nav-group .btn:hover { background: #f5f5f5; }

        .zoom-group { display: flex; align-items: center; gap: 4px; }
        .zoom-group .btn {
            font-size: 0.75rem;
            padding: 2px 6px;
            color: #555;
            border: 1px solid transparent;
        }
        .zoom-group .btn.active { background: #f1f3f4; border-color: #dadce0; font-weight: bold; }
        
        #row-height-input {
            width: 40px;
            font-size: 0.75rem;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            height: 24px;
        }

        /* Slogan */
        .slogan-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #slogan-input {
            border: 1px dashed transparent;
            background: transparent;
            font-size: 0.9rem;
            font-weight: 500;
            color: #444;
            text-align: center;
            padding: 2px 8px;
            border-radius: 4px;
            width: 240px;
            transition: all 0.2s;
        }
        #slogan-input::placeholder {
            font-style: italic;
            color: #aaa;
            font-weight: normal;
        }
        #slogan-input:hover { border-color: #ddd; }
        #slogan-input:focus { outline: none; border-color: #1967d2; background: #fff; color: #000; }

        /* Tools */
        .right-tools { 
            margin-left: auto;
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        
        .btn-text {
            font-size: 0.8rem;
            padding: 4px 8px;
            color: #444;
            border: 1px solid transparent;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-text:hover { background: #f1f3f4; color: #000; }
        .btn-text-danger { color: #d93025; }
        .btn-text-danger:hover { background: #fce8e6; color: #c5221f; }

        .btn-icon-tool {
            padding: 2px 6px; color: #555; border: 1px solid #ddd; border-radius: 4px; background: white;
            font-size: 0.8rem;
        }
        .btn-icon-tool:hover { background: #f5f5f5; }
        .btn-icon-tool:disabled { color: #ccc; cursor: default; }

        /* Category/Location Buttons */
        #eventCategoryButtons .btn.active,
        #eventLocationButtons .btn.active {
            background-color: #1967d2;
            color: white;
            border-color: #1967d2;
        }

        /* Paint Tools */
        .paint-wrapper { display: flex; align-items: center; gap: 4px; }
        .paint-dropdown-toggle {
            display: flex; align-items: center; gap: 4px;
            padding: 2px 6px; border: 1px solid #eee; border-radius: 4px;
            background: white; cursor: pointer; height: 24px;
        }
        .current-paint-color { width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); }

        /* Mode Switch */
        .mode-switch { background: #f1f3f4; padding: 2px; border-radius: 4px; display: flex; }
        .mode-btn { border: none; background: transparent; padding: 1px 8px; border-radius: 3px; font-size: 0.75rem; color: #666; }
        .mode-btn.active { background: white; color: black; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .mode-btn.active-paint { background: #feeFC3; color: #b06000; }

        /* --- Calendar View --- */
        #calendar-view { flex: 1; padding: 0; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        #calendar { flex: 1; height: 100%; }

        #analysis-view { flex: 1; padding: 20px; display: none; overflow-y: auto; background-color: #fafafa; }
        
        /* FullCalendar Customization */
        .fc-theme-standard td, .fc-theme-standard th { border-color: #f0f0f0; }
        .fc-timegrid-slot { 
            height: var(--slot-height) !important; 
            line-height: 1 !important;
            border-bottom: 1px solid #f0f0f0 !important;
        }
        
        /* Time Labels */
        .time-label-custom {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: flex-end;
            cursor: pointer; font-size: 0.75em; padding-right: 4px; user-select: none;
        }
        .time-label-custom:hover { background: rgba(0,0,0,0.02); }
        .time-label-visible { color: #888; }
        .time-label-transparent { color: transparent; }
        .time-label-config { font-weight: bold; }

        /* Events */
        .fc-event { 
            border: none; border-radius: 3px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            font-size: 0.8em; padding: 0; overflow: hidden;
            transition: transform 0.1s;
        }
        .fc-event:hover { z-index: 50 !important; }
        .fc-event-main { padding: 1px 2px 1px 6px; } /* Left padding for location bar */

        .fc-bg-event { opacity: 0.8 !important; z-index: 1; } 
        .fc-timegrid-now-indicator-line { border-color: #ea4335; z-index: 4; }

        /* Header Date */
        .fc-col-header-cell-cushion { width: 100%; text-decoration: none !important; color: inherit; padding: 4px 2px; }
        .date-header-container { position: relative; width: 100%; text-align: center; }
        .date-text { font-weight: 600; font-size: 0.85rem; }
        .date-note { font-size: 0.7em; color: #1967d2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
        .date-badge {
            position: absolute; top: -2px; right: 4px;
            width: 6px; height: 6px; background-color: #d93025; border-radius: 50%;
            display: none;
        }
        .date-badge.has-note { display: block; }

        /* Palettes */
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; padding: 8px; width: 220px; }
        .color-cell { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-cell:hover { transform: scale(1.2); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Analysis */
        .analysis-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin: 0 auto; max-width: 900px; }

        /* Context Menu */
        #context-menu {
            position: absolute; z-index: 9999; background: white;
            border: 1px solid #e0e0e0; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none; min-width: 120px; padding: 4px 0;
        }
        .context-menu-item {
            padding: 6px 12px; font-size: 0.85rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .context-menu-item:hover { background-color: #f5f5f5; color: #1967d2; }

        .location-indicator {
            position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        }


        /* Duration Input Group */
        .duration-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .duration-input-group input {
            flex: 1;
        }
        .duration-btn {
            padding: 2px 8px;
            font-size: 0.75rem;
            min-width: 32px;
        }
    </style>
</head>
<body oncontextmenu="return false;"> 

<div id="app-container">
    <div id="header-bar">
        <div class="view-tabs btn-group">
            <button class="btn active" id="tab-plan" onclick="switchMainTab('calendar')">日历</button>
            <button class="btn" id="tab-stats" onclick="switchMainTab('analysis')">分析</button>
        </div>

        <div class="sep"></div>

        <div id="group-nav" class="nav-group btn-group tool-group-calendar">
            <button class="btn btn-sm btn-light border-0" onclick="calendar.prev()"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-sm btn-light border-0" onclick="calendar.next()"><i class="bi bi-chevron-right"></i></button>
            <button class="btn btn-sm btn-light border-0 fw-bold" onclick="calendar.today()">今</button>
        </div>
        
        <span id="current-week-badge" class="badge bg-light text-secondary border fw-normal cursor-pointer tool-group-calendar" onclick="openSettings()">W?</span>

        <div class="sep tool-group-calendar"></div>

        <div id="group-zoom" class="zoom-group tool-group-calendar">
            <button class="btn" id="zoom-fit" onclick="setZoomMode('fit')">全屏</button>
            <button class="btn" id="zoom-normal" onclick="setZoomMode('normal')">普通</button>
            <input type="number" id="row-height-input" placeholder="pt" onkeydown="handleRowHeightKey(event)">
        </div>
        
        <div class="slogan-container tool-group-calendar">
            <input type="text" id="slogan-input" placeholder="锻炼直觉" onchange="saveSlogan()">
        </div>

        <div class="right-tools">
            <div id="group-history" class="d-flex gap-1 tool-group-calendar me-2">
                <button class="btn btn-icon-tool" id="btn-undo" onclick="executeUndo()" title="撤回" disabled><i class="bi bi-arrow-counterclockwise"></i></button>
                <button class="btn btn-icon-tool" id="btn-redo" onclick="executeRedo()" title="重做" disabled><i class="bi bi-arrow-clockwise"></i></button>
            </div>

            <div id="paint-tools" style="display:none;">
                <div class="paint-wrapper">
                    <button class="btn btn-icon-tool text-danger border-0" onclick="clearAllPaintOnPage()"><i class="bi bi-eraser-fill"></i></button>
                    <div class="dropdown">
                        <div class="paint-dropdown-toggle" data-bs-toggle="dropdown">
                            <div id="current-paint-preview" class="current-paint-color" style="background-color: #e0e0e0;"></div>
                            <i class="bi bi-chevron-down small text-muted ms-1" style="font-size:0.6em"></i>
                        </div>
                        <div class="dropdown-menu p-0">
                            <div class="color-grid" id="paint-palette-grid"></div>
                            <div class="p-2 border-top text-center"><small class="text-muted cursor-pointer" onclick="openPaletteManager()">管理色板</small></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mode-switch tool-group-calendar" id="group-mode">
                <button class="mode-btn active" id="mode-event" onclick="setMode('event')">事件</button>
                <button class="mode-btn" id="mode-paint" onclick="setMode('paint')">染色</button>
            </div>

            <div class="sep tool-group-calendar"></div>

            <div class="d-flex gap-1 tool-group-calendar">
                <button class="btn-text" onclick="openCategoryManager()">属性</button>
                <button class="btn-text" onclick="openLocationManager()">位置</button>
            </div>
            
            <div class="sep"></div>

            <input type="file" id="hiddenImportInput" style="display:none" accept=".json" onchange="handleFileImport(this)">
            <button class="btn-text" onclick="document.getElementById('hiddenImportInput').click()">导入</button>
            
            <button class="btn-text" onclick="quickSave()">快速保存</button>
            <button class="btn-text" onclick="openExportModal()">导出</button>
            <button class="btn-text tool-group-calendar" onclick="exportToPNG()" title="导出为PNG">PNG</button>
            <button class="btn-text btn-text-danger" onclick="clearAllData()">清空</button>
        </div>
    </div>

    <div id="calendar-view">
        <div id="calendar"></div>
    </div>

    <div id="analysis-view">
        <div class="analysis-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="m-0 fw-bold">数据统计</h6>
                <div class="d-flex gap-2 align-items-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="statsDim" id="dim-cat" value="category" checked onchange="generateAnalysis()">
                        <label class="btn btn-outline-secondary" for="dim-cat">按属性</label>
                        <input type="radio" class="btn-check" name="statsDim" id="dim-loc" value="location" onchange="generateAnalysis()">
                        <label class="btn btn-outline-secondary" for="dim-loc">按位置</label>
                    </div>
                    <div class="sep mx-2" style="height:20px"></div>
                    <select class="form-select form-select-sm" id="analysisPreset" onchange="syncAnalysisDates()" style="width:100px;">
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                        <option value="today">今日</option>
                        <option value="all">全部</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
            </div>
            
            <div class="row mb-3" id="customAnalysisRange" style="display:none">
                <div class="col-12 d-flex justify-content-end gap-2">
                    <input type="date" class="form-control form-control-sm w-auto" id="analysisStart" onchange="generateAnalysis()">
                    <span class="align-self-center">-</span>
                    <input type="date" class="form-control form-control-sm w-auto" id="analysisEnd" onchange="generateAnalysis()">
                </div>
            </div>

            <div class="row">
                <div class="col-md-5"><canvas id="analysisChart"></canvas></div>
                <div class="col-md-7">
                     <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="baseTotal" onchange="generateAnalysis()">
                        <label class="form-check-label small" for="baseTotal">包含未记录时间 (空白)</label>
                    </div>
                    <div id="stats-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="context-menu">
    <div class="context-menu-item" id="ctx-copy" onclick="handleCopy()">
        <span>复制</span> <i class="bi bi-clipboard"></i>
    </div>
</div>

<div class="modal fade" id="dayNoteModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title">日期备注</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="dayNoteDate"><label class="small text-muted mb-1">简短标题 (显示在日历)</label><input type="text" class="form-control mb-2" id="dayNoteInput" placeholder="例如: 节假日"><label class="small text-muted mb-1">详细记录 (仅显示角标)</label><textarea class="form-control mb-3" id="dayLongNoteInput" rows="4" placeholder="详细的日记或备注..."></textarea><button class="btn btn-primary btn-sm w-100" onclick="saveDayNote()">保存</button></div></div></div></div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title">编辑事件</h6>
                <div class="ms-auto d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary py-0" onclick="pasteToModal()"><i class="bi bi-clipboard-plus"></i></button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label small text-muted mb-1">属性 (Category)</label>
                            <div class="d-flex gap-1 mb-1" id="eventCategoryButtons"></div>
                            <select class="form-select form-select-sm" id="eventCategory"></select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted mb-1">位置 (Location)</label>
                            <div class="d-flex gap-1 mb-1" id="eventLocationButtons"></div>
                            <select class="form-select form-select-sm" id="eventLocation"></select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label small text-muted mb-1">开始</label>
                            <input type="datetime-local" class="form-control form-control-sm" id="eventStartInput" onchange="handleStartTimeChange()">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted mb-1">结束</label>
                            <input type="datetime-local" class="form-control form-control-sm" id="eventEndInput" onchange="handleEndTimeChange()">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small text-muted mb-1">持续时间</label>
                        <div class="duration-input-group">
                            <input type="text" class="form-control form-control-sm" id="eventDurationInput" readonly>
                            <button type="button" class="btn btn-sm btn-outline-secondary duration-btn" onclick="adjustDuration(-15)">-</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary duration-btn" onclick="adjustDuration(15)">+</button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small text-muted mb-1">名称</label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="默认使用属性名">
                    </div>
                    <div class="mb-3">
                         <label class="form-label small text-muted mb-1">详细描述</label>
                         <textarea class="form-control form-control-sm" id="eventDesc" rows="3"></textarea>
                    </div>
                    <div class="d-flex justify-content-between pt-2 border-top">
                        <button type="button" class="btn btn-sm btn-outline-danger" id="btnDeleteEvent" style="display:none;" onclick="deleteCurrentEvent()">删除</button>
                        <button type="button" class="btn btn-sm btn-primary ms-auto" onclick="saveEvent()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="timeRowModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header py-2"><h6 class="modal-title">时间轴设置</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="timeRowKey"><label class="small text-muted mb-1">文字</label><input type="text" class="form-control mb-2" id="timeRowText"><label class="small text-muted mb-1">颜色</label><div class="dropdown mb-2"><button class="btn btn-sm btn-outline-secondary w-100 d-flex justify-content-between align-items-center" type="button" id="timeRowColorBtn" data-bs-toggle="dropdown"><span id="timeRowColorPreview" style="display:inline-block;width:20px;height:20px;background:#000000;border:1px solid #ddd;border-radius:3px;"></span><span id="timeRowColorText">选择颜色</span><i class="bi bi-chevron-down"></i></button><ul class="dropdown-menu p-2" style="min-width:250px;"><li class="mb-2"><div class="color-grid" id="timeRowPaletteGrid" style="width:100%;"></div></li><li class="border-top pt-2"><div class="input-group input-group-sm"><input type="text" class="form-control" id="timeRowColorHex" placeholder="#000000" pattern="#[0-9A-Fa-f]{6}"><button class="btn btn-outline-secondary" type="button" onclick="applyTimeRowColorHex()">应用</button></div></li></ul></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="timeRowApplyBg"><label class="form-check-label small" for="timeRowApplyBg">应用为背景行</label></div><div class="d-flex gap-2"><button class="btn btn-outline-secondary btn-sm w-50" onclick="clearTimeRow()">重置</button><button class="btn btn-primary btn-sm w-50" onclick="saveTimeRow()">保存</button></div></div></div></div></div>

<div class="modal fade" id="exportModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content"><div class="modal-header"><h6 class="modal-title">导出/保存</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <label class="small text-muted mb-1">文件名 (无后缀)</label>
    <input type="text" class="form-control mb-3" id="exportFilename" placeholder="daily_profile">
    <label class="small text-muted mb-1">范围</label>
    <select class="form-select mb-3" id="exportRangeType" onchange="toggleExportInputs()"><option value="all">全部数据</option><option value="month">本月</option><option value="week">本周</option><option value="custom">自定义范围</option></select><div id="exportCustomInputs" class="mb-3" style="display:none;"><input type="date" class="form-control form-control-sm mb-1" id="exportStart"><input type="date" class="form-control form-control-sm" id="exportEnd"></div><button class="btn btn-primary w-100" onclick="executeExport()">下载 .json</button></div></div></div></div>

<div class="modal fade" id="managerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="managerTitle">管理</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="card bg-light border-0 mb-3"><div class="card-body p-3"><input type="hidden" id="mgrType"><input type="hidden" id="mgrEditId"><div class="input-group mb-2"><input type="text" class="form-control" id="mgrNameInput" placeholder="名称"><input type="color" class="form-control form-control-color" id="mgrColorInput" value="#Aecce6"></div><div id="mgr-palette-grid" class="color-grid w-100"></div><button class="btn btn-success btn-sm w-100 mt-2" onclick="saveManagerItem()">保存</button></div></div><ul class="list-group list-group-flush" id="managerList" style="max-height: 200px; overflow-y: auto;"></ul></div></div></div></div>

<div class="modal fade" id="paletteModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="modal-title">编辑色板</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="input-group mb-3"><input type="color" class="form-control form-control-color" id="newPaletteColor" value="#ffffff"><button class="btn btn-outline-secondary" type="button" onclick="addToPalette()">添加</button></div><div id="edit-palette-grid" class="color-grid w-100"></div></div></div></div></div>
<div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h6 class="modal-title">设置</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><label class="form-label small">Week 0 Start Date</label><input type="date" class="form-control mb-3" id="weekOneDateInput"><button class="btn btn-primary btn-sm w-100" onclick="saveSettings()">保存</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
    // --- Data & State ---
    const STORAGE_KEY = 'feiceProfiler_v3_fixed'; 
    const DEFAULT_PALETTE = ['#Aecce6', '#Beb5d8', '#Ebdc85', '#Bfc0c2', '#B4d9b6', '#e06666', '#f6b26b', '#ffd966', '#93c47d', '#76a5af', '#6d9eeb', '#8e7cc3', '#c27ba0', '#a61c00', '#434343', '#ffffff', '#e0e0e0', '#FF7800'];
    
    // Core Data Structure
    let appData = { 
        weekOneDate: '2025-09-08', 
        slogan: "", 
        palette: [...DEFAULT_PALETTE], 
        categories: [
            { id: 'work', name: '工作', color: '#Aecce6' }, 
            { id: 'study', name: '学习', color: '#Aecce6' }, 
            { id: 'sleep', name: '睡觉', color: '#Beb5d8' }, 
            { id: 'eat', name: '吃饭', color: '#Ebdc85' },
            { id: 'life', name: '生活', color: '#B4d9b6' }, 
            { id: 'ent', name: '娱乐', color: '#Bfc0c2' },
            { id: 'star', name: '*', color: '#FF7800' } 
        ], 
        locations: [
            { id: 'loc_desk', name: '工位', color: '#6baed6' }, 
            { id: 'loc_bed', name: '床上', color: '#8e7cc3' }, 
            { id: 'loc_out', name: '外出', color: '#f6b26b' }  
        ],
        events: [], 
        dayNotes: {}, 
        dayLongNotes: {},
        timeRowConfig: {},
        lastExportConfig: { filename: 'daily_profile', range: 'all' }
    };
    
    // History Stack
    const MAX_HISTORY = 30;
    let historyStack = [];
    let redoStack = [];

    let calendar;
    let chartInstance = null;
    let isPaintMode = false;
    let currentPaintColor = appData.palette[0];
    let clipboardEvent = null; 
    let ctxMenuTargetEventId = null;

    // --- Init ---
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        initCalendar();
        renderAllPalettes();
        updateUndoRedoUI();
        
        document.getElementById('current-paint-preview').style.backgroundColor = currentPaintColor;
        document.getElementById('slogan-input').value = appData.slogan || "";
        
        setZoomMode('fit'); 

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { if(document.getElementById('zoom-fit').classList.contains('active')) applyZoom('fit'); }, 100);
        });
        
        document.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');
        syncAnalysisDates();
    });

    // --- History System ---
    function pushHistory() {
        const state = JSON.parse(JSON.stringify(appData));
        historyStack.push(state);
        if (historyStack.length > MAX_HISTORY) historyStack.shift();
        redoStack = []; 
        updateUndoRedoUI();
    }
    
    function executeUndo() {
        if (historyStack.length === 0) return;
        
        // Save current state to redo stack
        const current = JSON.parse(JSON.stringify(appData));
        redoStack.push(current);
        
        // Restore previous state
        const prev = historyStack.pop();
        appData = prev;
        
        restoreState();
    }
    
    function executeRedo() {
        if (redoStack.length === 0) return;
        
        // Save current state to history stack
        const current = JSON.parse(JSON.stringify(appData));
        historyStack.push(current);
        
        // Restore redo state
        const next = redoStack.pop();
        appData = next;
        
        restoreState();
    }
    
    function restoreState() {
        // 1. Refresh Calendar with restored data
        // Key Fix: Do NOT call saveData() before this, otherwise it overwrites appData with current (wrong) UI state.
        reloadCalendar();
        
        // 2. Refresh other UI elements
        document.getElementById('slogan-input').value = appData.slogan || "";
        renderAllPalettes();
        
        // 3. Persist restored state to LocalStorage
        // We use the restored 'appData' directly, ignoring whatever the calendar might emit during reload.
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        
        updateUndoRedoUI();
        if(document.getElementById('analysis-view').style.display === 'block') generateAnalysis();
    }
    
    function updateUndoRedoUI() {
        document.getElementById('btn-undo').disabled = historyStack.length === 0;
        document.getElementById('btn-redo').disabled = redoStack.length === 0;
    }

    // --- Data Persistence ---
    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY); 
        if (saved) { 
            const parsed = JSON.parse(saved);
            appData = { ...appData, ...parsed };
            // Defaults protection
            if(!appData.categories || appData.categories.length === 0) {
                 appData.categories = [
                    { id: 'work', name: '工作', color: '#Aecce6' }, 
                    { id: 'study', name: '学习', color: '#Aecce6' }, 
                    { id: 'sleep', name: '睡觉', color: '#Beb5d8' }, 
                    { id: 'eat', name: '吃饭', color: '#Ebdc85' },
                    { id: 'life', name: '生活', color: '#B4d9b6' },
                    { id: 'ent', name: '娱乐', color: '#Bfc0c2' },
                    { id: 'star', name: '*', color: '#FF7800' }
                ];
            }
            if(!appData.locations || appData.locations.length === 0) {
                appData.locations = [
                    { id: 'loc_desk', name: '工位', color: '#6baed6' },
                    { id: 'loc_bed', name: '床上', color: '#8e7cc3' },
                    { id: 'loc_out', name: '外出', color: '#f6b26b' }
                ];
            }
            if(!appData.dayLongNotes) appData.dayLongNotes = {};
            if(!appData.weekOneDate) appData.weekOneDate = '2025-09-08';
        } else {
            // 首次加载，设置默认值
            appData.weekOneDate = '2025-09-08';
        }
    }

    function saveData(skipHistory) {
        if(calendar) {
            // Sync current view to model
            appData.events = calendar.getEvents().map(e => ({
                id: e.id, title: e.title, start: e.start, end: e.end, 
                extendedProps: e.extendedProps, display: e.display, backgroundColor: e.backgroundColor 
            }));
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        if(!skipHistory) updateUndoRedoUI();
    }
    
    function saveSlogan() { pushHistory(); appData.slogan = document.getElementById('slogan-input').value; saveData(); }

    function clearAllData() {
        if(confirm('警告：确定要清空所有数据吗？此操作无法撤销。')) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // --- UI Logic ---
    function switchMainTab(tab) {
        document.getElementById('tab-plan').classList.toggle('active', tab === 'calendar');
        document.getElementById('tab-stats').classList.toggle('active', tab === 'analysis');
        document.getElementById('calendar-view').style.display = tab === 'calendar' ? 'flex' : 'none';
        document.getElementById('analysis-view').style.display = tab === 'analysis' ? 'block' : 'none';
        
        const isStats = (tab === 'analysis');
        document.querySelectorAll('.tool-group-calendar').forEach(el => el.classList.toggle('d-none', isStats));

        if(tab === 'calendar') { 
            setTimeout(() => reloadCalendar(), 0);
        } else { 
            syncAnalysisDates(); 
            generateAnalysis(); 
        }
    }

    function setMode(mode) {
        isPaintMode = (mode === 'paint');
        document.getElementById('mode-event').className = isPaintMode ? 'mode-btn' : 'mode-btn active';
        document.getElementById('mode-paint').className = isPaintMode ? 'mode-btn active-paint' : 'mode-btn';
        document.getElementById('paint-tools').style.display = isPaintMode ? 'block' : 'none';
    }

    // --- Calendar ---
    function reloadCalendar() {
        if(!calendar) return;
        const d = calendar.getDate();
        calendar.destroy();
        initCalendar(d);
    }

    function initCalendar(initialDate) {
        const calendarEl = document.getElementById('calendar');
        
        calendarEl.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            if (e.target.closest('.fc-event')) {
                ctxMenuTargetEventId = e.target.closest('.fc-event').fcSeg.eventRange.def.publicId;
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            } else {
                menu.style.display = 'none';
            }
        });

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            initialDate: initialDate || new Date(),
            headerToolbar: false, 
            locale: 'zh-cn', firstDay: 1, allDaySlot: false,
            nowIndicator: true,
            selectable: true, editable: true, eventResizableFromStart: true,
            slotDuration: '00:30:00',
            slotLabelInterval: '00:30:00',
            slotLabelFormat: { hour: 'numeric', minute: '2-digit', hour12: false },
            
            // Custom Time Labels
            slotLabelContent: function(arg) {
                const ms = (arg.date.getHours() * 3600000) + (arg.date.getMinutes() * 60000);
                const timeKey = ms.toString();
                const config = appData.timeRowConfig[timeKey];
                
                let text = arg.text;
                let css = 'time-label-visible';
                let style = '';

                if (config) {
                    text = config.text || text;
                    css = 'time-label-config';
                    if(config.color) style = `color:${config.color}`;
                } else if (arg.date.getMinutes() !== 0) {
                    css = 'time-label-transparent';
                }
                
                return { html: `<div class="time-label-custom ${css}" style="${style}" onclick="openTimeRowModal('${timeKey}')">${text}</div>` };
            },
            
            // Row Backgrounds
            slotLaneDidMount: function(arg) {
                 const ms = (arg.time.milliseconds);
                 const config = appData.timeRowConfig[ms.toString()];
                 if (config && config.applyBg && config.color) {
                     arg.el.style.backgroundColor = hexToRgba(config.color, 0.15);
                 }
            },

            // Date Headers (Short note + Badge)
            dayHeaderContent: function(args) {
                const date = args.date;
                const offset = date.getTimezoneOffset() * 60000;
                const localDateStr = new Date(date.getTime() - offset).toISOString().split('T')[0];
                const weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const text = `${date.getMonth() + 1}/${date.getDate()} ${weekdays[date.getDay()]}`;
                
                const note = appData.dayNotes[localDateStr] || "";
                const hasLongNote = !!appData.dayLongNotes[localDateStr];

                return { html: `
                    <div class="date-header-container" onclick="openDayNoteModal('${localDateStr}')">
                        <div class="date-text">${text}</div>
                        ${note ? `<div class="date-note">"${note}"</div>` : ''}
                        <div class="date-badge ${hasLongNote ? 'has-note' : ''}"></div>
                    </div>` 
                };
            },
            
            height: '100%',
            events: appData.events,
            
            datesSet: function(info) { updateWeekBadge(info.view); },
            eventClick: function(info) { 
                if (info.event.display === 'background') return;
                if (!isPaintMode) openEventModal(info.event); 
            },
            select: function(info) { 
                if (isPaintMode) addPaintEvent(info.start, info.end); 
                else openEventModal(null, info.start, info.end); 
            },
            eventDrop: function() { pushHistory(); saveData(); }, 
            eventResize: function() { pushHistory(); saveData(); },
            
            // Event Rendering (Location Bar)
            eventDidMount: function(info) {
                if (info.event.display === 'background') {
                    if (info.event.backgroundColor) info.el.style.backgroundColor = hexToRgba(info.event.backgroundColor, 0.2);
                } else {
                    const props = info.event.extendedProps || {};
                    const catId = props.categoryId;
                    const cat = appData.categories.find(c => c.id === catId);
                    if(cat) { 
                        info.el.style.backgroundColor = cat.color; 
                        info.el.style.color = '#222'; 
                    }
                    // Location Indicator (Left Border)
                    const locId = props.locationId;
                    const loc = appData.locations.find(l => l.id === locId);
                    if (loc) {
                        info.el.style.borderLeft = `5px solid ${loc.color}`;
                    }
                }
            }
        });
        calendar.render();
    }

    // --- Modals & Business Logic ---
    
    // Day Notes
    const dayNoteModal = new bootstrap.Modal(document.getElementById('dayNoteModal'));
    function openDayNoteModal(dateStr) { 
        document.getElementById('dayNoteDate').value = dateStr; 
        document.getElementById('dayNoteInput').value = appData.dayNotes[dateStr] || ''; 
        document.getElementById('dayLongNoteInput').value = appData.dayLongNotes[dateStr] || ''; 
        dayNoteModal.show(); 
    }
    function saveDayNote() { 
        pushHistory();
        const d = document.getElementById('dayNoteDate').value; 
        const shortTxt = document.getElementById('dayNoteInput').value; 
        const longTxt = document.getElementById('dayLongNoteInput').value;
        
        if (shortTxt) appData.dayNotes[d] = shortTxt; else delete appData.dayNotes[d];
        if (longTxt) appData.dayLongNotes[d] = longTxt; else delete appData.dayLongNotes[d];
        
        saveData(); calendar.render(); dayNoteModal.hide(); 
    }

    // Events
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    function toISO(date) { const offset = date.getTimezoneOffset() * 60000; return (new Date(date - offset)).toISOString().slice(0, 16); }
    
    function populateSelect(id, items) {
        const sel = document.getElementById(id); sel.innerHTML = '';
        items.forEach(i => { const opt = document.createElement('option'); opt.value = i.id; opt.textContent = i.name; sel.appendChild(opt); });
    }
    
    function renderCategoryButtons() {
        const container = document.getElementById('eventCategoryButtons');
        container.innerHTML = '';
        // 显示前3个常用选项作为一级按钮
        const commonCats = appData.categories.slice(0, 3);
        commonCats.forEach(cat => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-secondary flex-fill';
            btn.style.fontSize = '0.75rem';
            btn.dataset.catId = cat.id;
            btn.innerHTML = `<span style="display:inline-block;width:8px;height:8px;background:${cat.color};border-radius:2px;margin-right:4px;"></span>${cat.name}`;
            btn.onclick = () => {
                document.getElementById('eventCategory').value = cat.id;
                // 更新按钮状态
                container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            container.appendChild(btn);
        });
    }
    
    function renderLocationButtons() {
        const container = document.getElementById('eventLocationButtons');
        container.innerHTML = '';
        // 显示前3个常用选项作为一级按钮
        const commonLocs = appData.locations.slice(0, 3);
        commonLocs.forEach(loc => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-secondary flex-fill';
            btn.style.fontSize = '0.75rem';
            btn.dataset.locId = loc.id;
            btn.innerHTML = `<span style="display:inline-block;width:8px;height:8px;background:${loc.color};border-radius:2px;margin-right:4px;"></span>${loc.name}`;
            btn.onclick = () => {
                document.getElementById('eventLocation').value = loc.id;
                // 更新按钮状态
                container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            container.appendChild(btn);
        });
    }
    
    function updateButtonStates(catId, locId) {
        updateCategoryButtonState(catId);
        updateLocationButtonState(locId);
    }
    
    function updateCategoryButtonState(catId) {
        const container = document.getElementById('eventCategoryButtons');
        container.querySelectorAll('button').forEach(btn => {
            const btnCatId = btn.dataset.catId;
            if (btnCatId === catId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
    
    function updateLocationButtonState(locId) {
        const container = document.getElementById('eventLocationButtons');
        container.querySelectorAll('button').forEach(btn => {
            const btnLocId = btn.dataset.locId;
            if (btnLocId === locId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function openEventModal(event, start, end) {
        populateSelect('eventCategory', appData.categories);
        populateSelect('eventLocation', appData.locations);
        renderCategoryButtons();
        renderLocationButtons();

        const isEdit = !!event;
        document.getElementById('btnDeleteEvent').style.display = isEdit ? 'block' : 'none';
        
        if (isEdit) {
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTitle').value = event.title;
            const catId = event.extendedProps.categoryId || appData.categories[0].id;
            const locId = event.extendedProps.locationId || appData.locations[0].id;
            document.getElementById('eventCategory').value = catId;
            document.getElementById('eventLocation').value = locId;
            document.getElementById('eventDesc').value = event.extendedProps.description || '';
            const startISO = toISO(event.start);
            const endISO = toISO(event.end);
            document.getElementById('eventStartInput').value = startISO;
            document.getElementById('eventEndInput').value = endISO;
            // 保存旧值用于持续时间计算
            document.getElementById('eventStartInput').dataset.oldValue = startISO;
            document.getElementById('eventEndInput').dataset.oldValue = endISO;
            // 更新按钮状态
            updateButtonStates(catId, locId);
        } else {
            document.getElementById('eventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDesc').value = '';
            const startISO = toISO(start);
            const endISO = toISO(end);
            document.getElementById('eventStartInput').value = startISO;
            document.getElementById('eventEndInput').value = endISO;
            // 保存旧值用于持续时间计算
            document.getElementById('eventStartInput').dataset.oldValue = startISO;
            document.getElementById('eventEndInput').dataset.oldValue = endISO;
            // 重置按钮状态
            document.getElementById('eventCategoryButtons').querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById('eventLocationButtons').querySelectorAll('button').forEach(b => b.classList.remove('active'));
        }
        
        // 更新持续时间显示
        updateDurationDisplay();
        
        // 添加回车键监听，自动保存
        const titleInput = document.getElementById('eventTitle');
        titleInput.onkeydown = function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEvent();
            }
        };
        
        // 监听下拉菜单变化，同步按钮状态
        document.getElementById('eventCategory').addEventListener('change', function() {
            updateCategoryButtonState(this.value);
        });
        document.getElementById('eventLocation').addEventListener('change', function() {
            updateLocationButtonState(this.value);
        });
        
        eventModal.show();
    }

    function saveEvent() {
        pushHistory();
        const id = document.getElementById('eventId').value;
        const title = document.getElementById('eventTitle').value;
        const catId = document.getElementById('eventCategory').value;
        const locId = document.getElementById('eventLocation').value;
        const desc = document.getElementById('eventDesc').value;
        const start = document.getElementById('eventStartInput').value;
        const end = document.getElementById('eventEndInput').value;
        
        const cat = appData.categories.find(c => c.id === catId);
        const displayTitle = title.trim() || cat.name;
        
        const eventData = {
            title: displayTitle, start: start, end: end, backgroundColor: cat.color,
            extendedProps: { categoryId: catId, locationId: locId, description: desc }
        };

        if (id) {
            const ev = calendar.getEventById(id);
            ev.setProp('title', displayTitle);
            ev.setProp('backgroundColor', cat.color);
            ev.setDates(start, end);
            ev.setExtendedProp('categoryId', catId);
            ev.setExtendedProp('locationId', locId);
            ev.setExtendedProp('description', desc);
        } else {
            calendar.addEvent({ id: Date.now().toString(), ...eventData });
        }
        saveData(); eventModal.hide();
    }
    function deleteCurrentEvent() { 
        pushHistory();
        const id = document.getElementById('eventId').value; 
        if(id) { calendar.getEventById(id).remove(); saveData(); eventModal.hide(); } 
    }
    
    // Copy Paste
    function handleCopy() {
        if (!ctxMenuTargetEventId) return;
        const ev = calendar.getEventById(ctxMenuTargetEventId);
        if (ev) {
            clipboardEvent = {
                title: ev.title, duration: ev.end - ev.start,
                extendedProps: JSON.parse(JSON.stringify(ev.extendedProps))
            };
        }
        document.getElementById('context-menu').style.display = 'none';
    }
    function pasteToModal() {
        if (!clipboardEvent) return alert("剪贴板为空");
        document.getElementById('eventTitle').value = clipboardEvent.title;
        document.getElementById('eventCategory').value = clipboardEvent.extendedProps.categoryId;
        document.getElementById('eventLocation').value = clipboardEvent.extendedProps.locationId || '';
        document.getElementById('eventDesc').value = clipboardEvent.extendedProps.description || '';
    }

    // --- Managers (Category & Location) ---
    const managerModal = new bootstrap.Modal(document.getElementById('managerModal'));
    function openCategoryManager() { setupManager('category'); managerModal.show(); }
    function openLocationManager() { setupManager('location'); managerModal.show(); }

    function setupManager(type) {
        document.getElementById('mgrType').value = type;
        document.getElementById('managerTitle').textContent = type === 'category' ? '属性管理' : '位置管理';
        document.getElementById('mgrEditId').value = '';
        document.getElementById('mgrNameInput').value = '';
        renderManagerList(type);
        renderAllPalettes();
    }

    function renderManagerList(type) {
        const list = document.getElementById('managerList'); list.innerHTML = '';
        const items = type === 'category' ? appData.categories : appData.locations;
        items.forEach(c => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span><span class="color-cell d-inline-block align-middle me-2" style="background:${c.color}; width:14px; height:14px;"></span>${c.name}</span> <i class="bi bi-pencil small text-muted cursor-pointer" onclick="editManagerItem('${type}', '${c.id}')"></i>`;
            list.appendChild(li);
        });
    }

    function editManagerItem(type, id) {
        const items = type === 'category' ? appData.categories : appData.locations;
        const item = items.find(i => i.id === id);
        document.getElementById('mgrEditId').value = item.id;
        document.getElementById('mgrNameInput').value = item.name;
        document.getElementById('mgrColorInput').value = item.color;
    }

    function saveManagerItem() {
        pushHistory();
        const type = document.getElementById('mgrType').value;
        const id = document.getElementById('mgrEditId').value;
        const name = document.getElementById('mgrNameInput').value;
        const color = document.getElementById('mgrColorInput').value;
        if(!name) return;

        let items = type === 'category' ? appData.categories : appData.locations;
        
        if (id) {
            const item = items.find(i => i.id === id);
            if(item) { item.name = name; item.color = color; }
        } else {
            items.push({ id: type + '_' + Date.now(), name, color });
        }
        
        saveData();
        renderManagerList(type);
        if(type === 'category') reloadCalendar(); // Color update
        document.getElementById('mgrNameInput').value = '';
    }

    // --- Export & Import ---
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    function openExportModal() {
        document.getElementById('exportFilename').value = appData.lastExportConfig.filename;
        document.getElementById('exportRangeType').value = appData.lastExportConfig.range;
        toggleExportInputs();
        exportModal.show();
    }

    function toggleExportInputs() {
        const isCustom = document.getElementById('exportRangeType').value === 'custom';
        document.getElementById('exportCustomInputs').style.display = isCustom ? 'block' : 'none';
    }

    function getExportData(rangeType) {
        saveData();
        let dataToExport = JSON.parse(JSON.stringify(appData));
        
        let start, end;
        const now = new Date();
        
        if (rangeType === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
        } else if (rangeType === 'week') {
            const day = now.getDay() || 7;
            const s = new Date(now); s.setHours(0,0,0,0); s.setDate(s.getDate() - day + 1);
            const e = new Date(s); e.setDate(e.getDate() + 6); e.setHours(23,59,59);
            start = s; end = e;
        } else if (rangeType === 'custom') {
            const sVal = document.getElementById('exportStart').value;
            const eVal = document.getElementById('exportEnd').value;
            if (sVal && eVal) {
                start = new Date(sVal);
                end = new Date(eVal);
                end.setHours(23,59,59);
            }
        }

        // Only filter if we have valid dates
        if (rangeType !== 'all' && start && !isNaN(start.getTime()) && end && !isNaN(end.getTime())) {
            dataToExport.events = dataToExport.events.filter(ev => {
                const evStart = new Date(ev.start);
                return evStart >= start && evStart <= end;
            });
        }
        
        // Convert to Beijing Time (+08:00) for JSON output
        const toBJ = (d) => {
             if(!d) return null;
             const dt = new Date(d);
             if (isNaN(dt.getTime())) return d;
             const bjMs = dt.getTime() + (8 * 60 * 60 * 1000);
             return new Date(bjMs).toISOString().replace('Z', '+08:00');
        };
        
        if(dataToExport.events) {
            dataToExport.events.forEach(ev => {
                if(ev.start) ev.start = toBJ(ev.start);
                if(ev.end) ev.end = toBJ(ev.end);
            });
        }

        return dataToExport;
    }

    function downloadJson(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.json`;
        link.click();
    }

    function executeExport() {
        const filename = document.getElementById('exportFilename').value || 'daily_profile';
        const range = document.getElementById('exportRangeType').value;
        
        // Cache settings
        appData.lastExportConfig = { filename, range };
        saveData();

        const data = getExportData(range);
        downloadJson(data, filename);
        exportModal.hide();
    }

    function quickSave() {
        // 快速保存改为保存全部时间信息，直接下载
        saveData();
        const dataToExport = JSON.parse(JSON.stringify(appData));
        
        // Convert to Beijing Time (+08:00) for JSON output
        const toBJ = (d) => {
             if(!d) return null;
             const dt = new Date(d);
             if (isNaN(dt.getTime())) return d;
             const bjMs = dt.getTime() + (8 * 60 * 60 * 1000);
             return new Date(bjMs).toISOString().replace('Z', '+08:00');
        };
        
        if(dataToExport.events) {
            dataToExport.events.forEach(ev => {
                if(ev.start) ev.start = toBJ(ev.start);
                if(ev.end) ev.end = toBJ(ev.end);
            });
        }
        
        const filename = appData.lastExportConfig.filename || 'daily_profile';
        downloadJson(dataToExport, filename);
    }

    function handleFileImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm("导入将覆盖现有数据，确定继续？")) {
                    pushHistory();
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(imported));
                    location.reload();
                }
            } catch (err) { alert("文件错误"); }
        };
        reader.readAsText(file);
    }

    // --- Analysis ---
    function syncAnalysisDates() {
        document.getElementById('customAnalysisRange').style.display = document.getElementById('analysisPreset').value === 'custom' ? 'flex' : 'none';
        generateAnalysis();
    }

    function generateAnalysis() {
        const preset = document.getElementById('analysisPreset').value;
        const dim = document.querySelector('input[name="statsDim"]:checked').value; // 'category' or 'location'
        let start, end;
        
        const now = new Date();
        if(preset === 'week') {
             const day = now.getDay() || 7;
             start = new Date(now); start.setHours(0,0,0,0); start.setDate(start.getDate() - day + 1);
             end = new Date(start); end.setDate(end.getDate() + 6); end.setHours(23,59,59);
        } else if(preset === 'month') {
             start = new Date(now.getFullYear(), now.getMonth(), 1);
             end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
        } else if(preset === 'today') {
             start = new Date(now); start.setHours(0,0,0,0);
             end = new Date(now); end.setHours(23,59,59);
        } else if (preset === 'custom') {
             const sVal = document.getElementById('analysisStart').value;
             const eVal = document.getElementById('analysisEnd').value;
             if(!sVal || !eVal) return;
             start = new Date(sVal); start.setHours(0,0,0,0);
             end = new Date(eVal); end.setHours(23,59,59);
        } else {
             start = new Date(0); end = new Date(9999999999999);
        }

        const stats = {};
        const items = dim === 'category' ? appData.categories : appData.locations;
        items.forEach(i => stats[i.id] = 0);
        let totalLogged = 0;

        calendar.getEvents().forEach(e => {
            if (e.display === 'background') return;
            if (e.end <= start || e.start >= end) return;
            
            const s = e.start < start ? start : e.start;
            const ed = e.end > end ? end : e.end;
            const dur = ed - s;
            
            if (dur > 0) {
                const key = dim === 'category' ? e.extendedProps.categoryId : e.extendedProps.locationId;
                if(stats[key] !== undefined) {
                    stats[key] += dur;
                    totalLogged += dur;
                }
            }
        });

        const labels = [], data = [], colors = [];
        items.forEach(i => {
            if(stats[i.id] > 0) {
                labels.push(i.name);
                data.push((stats[i.id] / 3600000).toFixed(2));
                colors.push(i.color);
            }
        });

        let totalHours = totalLogged / 3600000;
        
        if(document.getElementById('baseTotal').checked && preset !== 'all') {
            const cap = end - start;
            const unallocated = cap - totalLogged;
            if(unallocated > 0) {
                labels.push('未记录');
                data.push((unallocated / 3600000).toFixed(2));
                colors.push('#eee');
                totalHours = cap / 3600000;
            }
        }

        const ctx = document.getElementById('analysisChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: colors }] },
            options: { 
                plugins: { 
                    title: { display: true, text: `总计: ${totalHours.toFixed(1)}h` },
                    legend: { position:'bottom' }
                } 
            }
        });

        // Table
        let html = `<table class="table table-sm mt-3"><thead><tr><th>${dim === 'category' ? '属性' : '位置'}</th><th>小时</th><th>%</th></tr></thead><tbody>`;
        labels.forEach((l, i) => {
            const val = parseFloat(data[i]);
            const pct = totalHours > 0 ? ((val/totalHours)*100).toFixed(1) : 0;
            html += `<tr><td><span style="display:inline-block;width:10px;height:10px;background:${colors[i]};margin-right:5px"></span>${l}</td><td>${val}</td><td>${pct}%</td></tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById('stats-table').innerHTML = html;
    }

    // --- Helpers ---
    function hexToRgba(hex, alpha) {
        let r = 0, g = 0, b = 0;
        if (hex.length === 4) { r=parseInt(hex[1]+hex[1],16); g=parseInt(hex[2]+hex[2],16); b=parseInt(hex[3]+hex[3],16); }
        else if (hex.length === 7) { r=parseInt(hex.substring(1,3),16); g=parseInt(hex.substring(3,5),16); b=parseInt(hex.substring(5,7),16); }
        return `rgba(${r},${g},${b},${alpha})`;
    }
    
    // Zoom / Misc
    function setZoomMode(mode) {
        document.getElementById('zoom-fit').classList.toggle('active', mode === 'fit');
        document.getElementById('zoom-normal').classList.toggle('active', mode === 'normal');
        if(mode !== 'custom') document.getElementById('row-height-input').value = '';
        applyZoom(mode);
    }
    function handleRowHeightKey(e) { if(e.key === 'Enter') applyZoom('custom', parseInt(e.target.value)); }
    function applyZoom(mode, customPx) {
        let h = 30;
        if (mode === 'custom') h = customPx || 30;
        else if (mode === 'fit') {
             const cont = document.getElementById('calendar-view');
             const avail = cont.clientHeight - 40;
             h = avail / 48; if(h < 10) h = 10;
        }
        document.documentElement.style.setProperty('--slot-height', h + 'px');
        reloadCalendar();
    }
    
    // Settings
    const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    function openSettings() { document.getElementById('weekOneDateInput').value = appData.weekOneDate || ''; settingsModal.show(); }
    function saveSettings() { appData.weekOneDate = document.getElementById('weekOneDateInput').value; saveData(); updateWeekBadge(calendar.view); settingsModal.hide(); }
    function updateWeekBadge(view) {
        const badge = document.getElementById('current-week-badge');
        if (appData.weekOneDate) {
            const start = new Date(appData.weekOneDate);
            const diff = view.activeStart - start;
            const weekNum = Math.floor(diff / (1000*60*60*24*7)) + 1;
            badge.textContent = `Week${weekNum}`;
        } else { badge.textContent = "Week?"; }
    }
    
    // Paint
    function addPaintEvent(start, end) { pushHistory(); calendar.addEvent({ id: 'bg_' + Date.now(), start: start, end: end, display: 'background', backgroundColor: currentPaintColor }); saveData(); }
    function clearAllPaintOnPage() { if(confirm("清除所有染色？")) { pushHistory(); const v = calendar.view; const evs = calendar.getEvents().filter(e => e.display === 'background' && e.start < v.activeEnd && e.end > v.activeStart); evs.forEach(e => e.remove()); saveData(); } }
    
    // Time Row & Misc Modals
    const timeRowModal = new bootstrap.Modal(document.getElementById('timeRowModal'));
    let currentTimeRowColor = '#000000';
    function openTimeRowModal(key) { 
        document.getElementById('timeRowKey').value = key; 
        const c = appData.timeRowConfig[key] || {}; 
        document.getElementById('timeRowText').value = c.text || ''; 
        currentTimeRowColor = c.color || '#000000';
        updateTimeRowColorUI(currentTimeRowColor);
        document.getElementById('timeRowApplyBg').checked = !!c.applyBg; 
        renderTimeRowPalette();
        timeRowModal.show(); 
    }
    function renderTimeRowPalette() {
        const grid = document.getElementById('timeRowPaletteGrid');
        if (!grid) return;
        grid.innerHTML = '';
        appData.palette.forEach(c => {
            const d = document.createElement('div');
            d.className = 'color-cell';
            d.style.background = c;
            d.onclick = () => {
                currentTimeRowColor = c;
                updateTimeRowColorUI(c);
            };
            grid.appendChild(d);
        });
    }
    function updateTimeRowColorUI(color) {
        currentTimeRowColor = color;
        document.getElementById('timeRowColorPreview').style.background = color;
        document.getElementById('timeRowColorText').textContent = color.toUpperCase();
        document.getElementById('timeRowColorHex').value = color;
    }
    function applyTimeRowColorHex() {
        const hex = document.getElementById('timeRowColorHex').value;
        if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            currentTimeRowColor = hex;
            updateTimeRowColorUI(hex);
        }
    }
    function saveTimeRow() { 
        pushHistory();
        const k = document.getElementById('timeRowKey').value; 
        const t = document.getElementById('timeRowText').value; 
        const c = currentTimeRowColor;
        const bg = document.getElementById('timeRowApplyBg').checked;
        if(!t && !bg) delete appData.timeRowConfig[k]; else appData.timeRowConfig[k] = { text:t, color:c, applyBg:bg };
        saveData(); reloadCalendar(); timeRowModal.hide();
    }
    function clearTimeRow() { pushHistory(); delete appData.timeRowConfig[document.getElementById('timeRowKey').value]; saveData(); reloadCalendar(); timeRowModal.hide(); }

    // Palette Manager
    const paletteModal = new bootstrap.Modal(document.getElementById('paletteModal'));
    function openPaletteManager() { renderAllPalettes(); paletteModal.show(); }
    function addToPalette() { const c = document.getElementById('newPaletteColor').value; if(!appData.palette.includes(c)) { pushHistory(); appData.palette.push(c); renderAllPalettes(); saveData(); } }
    function renderAllPalettes() {
        ['paint-palette-grid', 'mgr-palette-grid', 'edit-palette-grid'].forEach(id => {
            const el = document.getElementById(id); if(!el) return; el.innerHTML = '';
            appData.palette.forEach(c => {
                const d = document.createElement('div'); d.className = 'color-cell'; d.style.background = c;
                d.onclick = () => {
                    if(id === 'paint-palette-grid') { currentPaintColor = c; document.getElementById('current-paint-preview').style.background = c; }
                    else if(id === 'mgr-palette-grid') document.getElementById('mgrColorInput').value = c;
                    else if(id === 'edit-palette-grid') { if(confirm('Delete?')) { pushHistory(); appData.palette = appData.palette.filter(x => x!==c); renderAllPalettes(); saveData(); } }
                };
                el.appendChild(d);
            });
        });
    }


    // --- Duration Management ---
    function updateDurationDisplay() {
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        const durationInput = document.getElementById('eventDurationInput');
        
        if (!startInput.value || !endInput.value) {
            durationInput.value = '';
            return;
        }
        
        const start = new Date(startInput.value);
        const end = new Date(endInput.value);
        const durationMs = end - start;
        
        if (durationMs < 0) {
            durationInput.value = '无效';
            return;
        }
        
        const hours = Math.floor(durationMs / 3600000);
        const minutes = Math.floor((durationMs % 3600000) / 60000);
        
        if (hours > 0) {
            durationInput.value = `${hours}小时${minutes}分钟`;
        } else {
            durationInput.value = `${minutes}分钟`;
        }
    }
    
    function handleStartTimeChange() {
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        
        if (!startInput.value) {
            updateDurationDisplay();
            return;
        }
        
        const start = new Date(startInput.value);
        
        // 如果有旧的开始时间，保持持续时间不变
        if (startInput.dataset.oldValue && endInput.value) {
            const oldStart = new Date(startInput.dataset.oldValue);
            const oldEnd = new Date(endInput.value);
            const duration = oldEnd - oldStart;
            
            // 保持持续时间不变，修改结束时间
            const newEnd = new Date(start.getTime() + duration);
            endInput.value = toISO(newEnd);
        } else if (!endInput.value) {
            // 如果没有结束时间，设置默认30分钟
            const defaultEnd = new Date(start.getTime() + 30 * 60000);
            endInput.value = toISO(defaultEnd);
        }
        
        // 保存当前值作为下次的旧值
        startInput.dataset.oldValue = startInput.value;
        if (endInput.value) {
            endInput.dataset.oldValue = endInput.value;
        }
        
        updateDurationDisplay();
    }
    
    function handleEndTimeChange() {
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        
        if (!startInput.value || !endInput.value) {
            updateDurationDisplay();
            return;
        }
        
        // 保存当前值作为下次的旧值
        startInput.dataset.oldValue = startInput.value;
        endInput.dataset.oldValue = endInput.value;
        
        updateDurationDisplay();
    }
    
    function adjustDuration(minutes) {
        const startInput = document.getElementById('eventStartInput');
        const endInput = document.getElementById('eventEndInput');
        
        if (!startInput.value) return;
        
        const start = new Date(startInput.value);
        let end = endInput.value ? new Date(endInput.value) : new Date(start.getTime() + 30 * 60000);
        
        // 调整结束时间
        end = new Date(end.getTime() + minutes * 60000);
        
        // 确保结束时间不早于开始时间
        if (end <= start) {
            end = new Date(start.getTime() + 15 * 60000);
        }
        
        endInput.value = toISO(end);
        
        // 保存当前值作为下次的旧值（用于开始时间改变时保持持续时间）
        startInput.dataset.oldValue = startInput.value;
        endInput.dataset.oldValue = endInput.value;
        
        updateDurationDisplay();
    }

    // --- PNG Export ---
    function exportToPNG() {
        if (document.getElementById('calendar-view').style.display === 'none') {
            alert('请在日历视图下导出');
            return;
        }
        
        const calendarEl = document.getElementById('calendar');
        
        // 等待一小段时间确保UI更新
        setTimeout(() => {
            if (typeof html2canvas !== 'undefined') {
                html2canvas(calendarEl, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    windowWidth: calendarEl.scrollWidth,
                    windowHeight: calendarEl.scrollHeight
                }).then(canvas => {
                    // 创建下载链接
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        const date = new Date();
                        const dateStr = date.toISOString().split('T')[0];
                        link.download = `calendar_${dateStr}.png`;
                        link.click();
                        URL.revokeObjectURL(url);
                    });
                }).catch(err => {
                    trackerIndicator.style.display = trackerDisplay;
                    console.error('导出失败:', err);
                    alert('导出失败，请重试');
                });
            } else {
                trackerIndicator.style.display = trackerDisplay;
                alert('导出功能加载中，请稍后再试');
            }
        }, 100);
    }
</script>
</body>
</html>